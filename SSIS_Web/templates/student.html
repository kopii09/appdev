{% extends "base.html" %} {% block title %} Student List {% endblock %}  {% block content %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/templates.css') }}"
/>

{% block scripts %}
  {{ super() }}
{% endblock %}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}


<!-- Navigation Links (inside container and above student section) -->
<div class="container" style="margin-top: 20px; text-align: center;">
  <div style="background-color: #800000; padding: 10px 20px; border-radius: 8px;">
    <div style="display: flex; gap: 30px;">
      <h1 style="font-size: 40px; margin: 0;">
        <a href="/students" style="color: white; text-decoration: none;">Student</a>
      </h1>
      <h1 style="font-size: 40px; margin: 0;">
        <a href="/courses" style="color: white; text-decoration: none;">Course</a>
      </h1>
      <h1 style="font-size: 40px; margin: 0;">
        <a href="/colleges" style="color: white; text-decoration: none;">College</a>
      </h1>
    </div>
  </div>
</div>

<div class="container mt-2">
  <!-- Search bar and Add button row -->
  <div class="row" style="display: flex; gap: 20px;align-items: center;  margin-top: 40px;">

    <div class="col mt-auto">
      <!-- Button to trigger the modal -->
      <button type="button" class="btn btn-outline-info" id="addButton">
        <img src="/static/assets/add.png" alt="Add" class="icon" />
        Add Student
      </button>
    </div>
    <div class="col order-md-last mt-auto">
      <!-- Dropdown menu for selecting search field and input field for search query -->
      <div class="field-selection">
        <!-- Dropdown menu for selecting search field -->
        <select class="form-select search-selector" id="searchField">
          <option value="all">All columns</option>
          <option value="id">ID</option>
          <option value="firstname">First name</option>
          <option value="lastname">Last name</option>
          <option value="course">Course</option>
          <option value="college">College</option>
          <option value="year">Year</option>
          <option value="gender">Gender</option>
        </select>

        <!-- Input field for search query -->
        <form id="searchForm" class="col-md-9">
        <div class="input-group custom-search-input ">
          <input
            type="text"
            class="form-control custom-search-input"
            id="searchInput"
            placeholder="Search"
          />
          <div class="input-group-append">
            <button
              type="button"
              class="btn btn-outline-info"
              id="searchButton"
            >
              <img src="/static/assets/search.png" alt="Search" class="icon" />
            </button>
          </div>
        </form>
        </div>
      </div>
    </div>
  </div>

  <div class="table-container">
  <!-- Bootstrap-styled table -->
    <table class="table table-hover">
      <!-- Table header -->
      <thead>
        <tr>
          <th scope="col"> </th>
          <th scope="col">ID</th>
          <th scope="col">First Name</th>
          <th scope="col">Last Name</th>
          <th scope="col">Course</th> 
          <th scope="col">College</th>
          <th scope="col">Year</th>
          <th scope="col">Gender</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Table rows for student data -->
        {% for student in student_data %}
        <tr class="student-row" data-student-id="{{ student.id }}" style="cursor: pointer;">
          <!-- Data for each column -->
          <td scope="row">
            <div class="circle-con">
              <img class="img" src="{% if not student.pic %}
                {{ url_for('static', filename='assets/default-picture.jpg') }}
                {% else %}
                {{ student.pic }}?v={{ range(1000000)|random }}
                {% endif %}" 
                style="height:55px; width:55px;"/>

            </div>
          </td>
          <td class="id">{{ student.id }}</td>
          <td class="firstname">{{ student.firstname }}</td>
          <td class="lastname">{{ student.lastname }}</td>
          <td class="course">{{ student.course }}</td>
          <td class="college">{{ student.college }}</td>
          <td class="year">{{ student.year }}</td>
          <td class="gender">{{ student.gender }}</td>
          <td>
            <div class="btn-group" role="group" onclick="event.stopPropagation()">
              <!-- Edit button -->
              <button
                class="btn btn-outline-info btn-sm edit-button row-button"
                data-toggle="modal" 
                data-target="#editStudentModal"
                data-student-pic="{{ student.pic }}"
                data-student-id="{{ student.id }}"
                data-firstname="{{ student.firstname }}"
                data-lastname="{{ student.lastname }}"
                data-course="{{ student.course }}"
                data-year="{{ student.year }}"
                data-gender="{{ student.gender }}"
              >
                <img src="/static/assets/edit.png" alt="Edit" class="icon row-button" />
              </button>
              
              <!-- Delete button form -->
              <form
                id="deleteStudentForm"
                action="/students/delete/{{ student.id }}"
                method="POST"
                class="row-button"
              >
                {{ form.hidden_tag() }}
                <button
                  class="btn btn-outline-danger btn-sm ml-10 delete-button row-button"
                  data-student-id="{{ student.id }}"
                  id="deleteStudentFromList"
                >
                  <img
                    src="/static/assets/delete.png"
                    alt="Delete"
                    class="icon row-button"
                  />
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <!-- Pagination Controls -->
    <nav aria-label="Student pagination">
      <ul class="pagination justify-content-center">

        <!-- Previous button -->
        {% if page > 1 %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('student.list_students', page=page-1) }}">Previous</a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">Previous</span>
          </li>
        {% endif %}

        <!-- Page numbers -->
        {% for p in range(1, total_pages + 1) %}
          <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('student.list_students', page=p) }}">{{ p }}</a>
          </li>
        {% endfor %}

        <!-- Next button -->
        {% if page < total_pages %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('student.list_students', page=page+1) }}">Next</a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">Next</span>
          </li>
        {% endif %}

      </ul>
    </nav>
  </div>

<!-- Student Details Modal -->
<div class="modal fade" id="studentDetailsModal" tabindex="-1" role="dialog" aria-labelledby="studentDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">

      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="studentDetailsModalLabel">Student Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body d-flex justify-content-center align-items-center flex-column" style="min-height: 400px;">

        <!-- Student Picture -->
        <div class="mb-4" style="margin-top: 70px;">
          <img id="detailsStudentPic" src="" alt="Student Picture"
              class="rounded-circle shadow"
              style="width: 150px; height: 150px; object-fit: cover; border: 3px solid #dee2e6;" />
        </div>

        <!-- Student Info Section -->
        <div class="text-start w-100 px-4">
          <div class="row">
            <div class="col-sm-6 mb-3">
              <p><strong>ID:</strong> <span id="detailsStudentID"></span></p>
              <p><strong>First Name:</strong> <span id="detailsFirstnName"></span></p>
              <p><strong>Last Name:</strong> <span id="detailsLastname"></span></p>
            </div>
            <div class="col-sm-6 mb-3">
              <p><strong>Course:</strong> <span id="detailsCourse"></span></p>
              <p><strong>College:</strong> <span id="detailsCollege"></span></p>
              <p><strong>Year:</strong> <span id="detailsYear"></span></p>
              <p><strong>Gender:</strong> <span id="detailsGender"></span></p>
            </div>
          </div>
        </div>

      </div>


    </div>
  </div>
</div>


<!-- EDIT Student Modal -->
<div class="modal fade" id="editStudentModal" tabindex="-1" role="dialog" aria-labelledby="editStudentModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editStudentModalLabel">Edit Student</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <!-- Modal body -->
      <div class="modal-body">
        <form id="editStudentForm" action="{{ url_for('student.edit_student_data') }}" method="POST" enctype="multipart/form-data">

          <!-- Centered Profile Image Preview -->
          <div class="text-center mb-4">
            <label for="file-input1" style="cursor: pointer; display: inline-block;">
              <input type="file" id="file-input1" name="pic1" class="d-none" accept="image/*" onchange="previewImage1(event)">
              <input id="image_url1" name="image_url1" type="hidden">
              <img 
                id="preview-image1"
                src="{{ url_for('static', filename='assets/default-picture.jpg') }}"
                alt="student-pic"
                class="rounded-circle shadow"
                style="width: 130px; height: 130px; object-fit: cover; opacity: 0.9; display: block; margin-left: auto; margin-right: auto;"
              />
            </label>
          </div>

          <!-- ID Number -->
          <div class="form-group mb-3">
            <label for="idnumber"><strong>ID Number:</strong></label>
            <input type="text" id="idnumber" name="studentID" class="form-control" pattern="\d{4}-\d{4}" required readonly />
            <small class="form-text text-muted">Format: YYYY-NNNN (e.g., 2023-1234)</small>
          </div>

          <!-- First and Last Name -->
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="firstname">First Name</label>
                <input type="text" class="form-control" id="firstname" name="firstname" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="lastname">Last Name</label>
                <input type="text" class="form-control" id="lastname" name="lastname" required>
              </div>
            </div>
          </div>

          <!-- Course and Year -->
          <div class="row">
            <div class="col-md-9">
              <div class="form-group">
                <label for="course">Course</label>
                <select class="form-select" id="course" name="course" required>
                  {% for course in courses %}
                    <option value="{{ course.code }}">{{ course.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label for="year">Year</label>
                <input type="number" class="form-control" id="year" name="year" required>
              </div>
            </div>
          </div>

          <!-- Gender -->
          <div class="form-group">
            <label for="gender">Gender</label>
            <select class="form-select" id="gender" name="gender" required>
              <option value="" disabled selected>Select gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Non-binary">Non-binary</option>
              <option value="Transgender">Transgender</option>
              <option value="Prefer not to say">Prefer not to say</option>
              <option value="Not listed">Not listed</option>
            </select>
          </div>

          <!-- CSRF Token -->
          {{ form.hidden_tag() }}

          <!-- Hidden originalStudentID -->
          <input type="hidden" id="originalStudentID" name="originalStudentID" value="">

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="closeEditModalButton" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>


  

        
    
<!-- Add Student Modal -->
<div class="modal fade" id="addStudentModal" tabindex="-1" role="dialog" aria-labelledby="addStudentModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addStudentModalLabel">Add Student</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        
        <!-- Profile Picture Preview - Top Centered -->
        <div class="text-center mb-4">
          <label for="pic" style="cursor:pointer;">
            <img
              id="preview-image"
              src="{{ url_for('static', filename='assets/default-picture.jpg') }}"
              alt="default-pic"
              class="rounded-circle shadow"
              style="width: 130px; height: 130px; object-fit: cover; opacity: 0.9;"
            />
            <input
              type="file"
              id="pic"
              name="pic"
              accept="image/*"
              style="display: none;"
              onchange="previewImage(event, this)"
            >
          </label>
        </div>


        <form id="addStudentForm" action="/students/add/" method="POST" enctype="multipart/form-data">


          <!-- ID Number -->
          <div class="form-group mb-3">
            <label for="idnumber"><strong>ID Number:</strong></label>
            <input type="text" id="idnumber" name="studentID" class="form-control" pattern="\d{4}-\d{4}" required />
            <small class="form-text text-muted">Format: YYYY-NNNN (e.g., 2023-1234)</small>
          </div>


          <!-- First Name -->
          <div class="form-group mb-3">
            <label for="firstname"><strong>First Name:</strong></label>
            <input type="text" id="firstname" name="firstname" class="form-control" required />
          </div>

          <!-- Last Name -->
          <div class="form-group mb-3">
            <label for="lastname"><strong>Last Name:</strong></label>
            <input type="text" id="lastname" name="lastname" class="form-control" required />
          </div>

          <!-- Course -->
          <div class="form-group mb-3">
            <label for="course"><strong>Course:</strong></label>
            <select id="course" name="course" class="form-select" required>
              {% for course in courses %}
                <option value="{{ course.code }}">{{ course.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Year -->
          <div class="form-group mb-3">
            <label for="year"><strong>Year:</strong></label>
            <input type="number" id="year" name="year" class="form-control" min="1" max="5" required />
          </div>

          <!-- Gender -->
          <div class="form-group mb-3">
            <label for="gender"><strong>Gender:</strong></label>
            <select id="gender" name="gender" class="form-select" required>
              <option value="" disabled selected>Select gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Non-binary">Non-binary</option>
              <option value="Transgender">Transgender</option>
              <option value="Prefer not to say">Prefer not to say</option>
              <option value="Not listed">Not listed</option>
            </select>
          </div>

          <!-- CSRF Token -->
          {{ form.hidden_tag() }}

          <!-- Footer Buttons -->
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Add Student</button>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>





<!-- Student Details Modal -->
<div class="modal fade" id="studentDetailsModal" tabindex="-1" role="dialog" aria-labelledby="studentDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="studentDetailsModalLabel">Student Details</h5>
        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="row">
          <div class="form-group" style="display: flex; justify-content: center; align-items: center;">
            <div class="image-circle" style="position: relative;">
              <img id="detailsStudentPic" src="" class="mb-3" />
            </div>
          </div>
        </div>
        <!-- Details arranged in a grid layout -->
        <div class="row">
          <div class="col-sm-6 text-left" style="padding-left: 50px">
            <div>ID: <strong><span id="detailsStudentID"></span></strong></div>
            <div>First Name: <strong><span id="detailsFirstname"></span></strong></div>
            <div>Last Name: <strong><span id="detailsLastname"></span></strong></div>
          </div>
          <div class="col-sm-6 text-left" style="padding-left: 20px">
            <div>Course: <strong><span id="detailsCourse"></span></strong></div>
            <div>College: <strong><span id="detailsCollege"></span></strong></div>
            <div>Year: <strong><span id="detailsYear"></span></strong></div>
            <div>Gender: <strong><span id="detailsGender"></span></strong></div>
          </div>
        </div>
      </div>
      
    </div>
  </div>
</div>

<script>
$(document).ready(function () {
  // Open Add Modal and reset form
  $("#addButton").click(function () {
    $("#addStudentForm")[0].reset();
    $("#preview-image").attr("src", "{{ url_for('static', filename='assets/default-picture.jpg') }}").css("opacity", 0.8);
    $("#addStudentModal").modal("show");
  });

  // Preview Image function for Add form
  window.previewImage = function(event, inputElement) {
    const file = inputElement.files[0];
    if (file && validateFileType(file)) {
      const reader = new FileReader();
      reader.onload = function(e) {
        $("#preview-image").attr("src", e.target.result).css("opacity", 1);
      };
      reader.readAsDataURL(file);
    }
  };


  function openEditModal(student) {
  document.getElementById('studentID').value = student.studentID;
  document.getElementsByName('originalStudentID')[0].value = student.studentID;
  document.getElementById('firstname').value = student.firstname;
  document.getElementById('lastname').value = student.lastname;
  document.getElementById('year').value = student.year;
  document.getElementById('gender').value = student.gender;

  const courseSelect = document.getElementById('course');
  [...courseSelect.options].forEach(option => {
    option.selected = option.value === student.course;
  });

  document.getElementById('preview-image1').src = student.pic || "{{ url_for('static', filename='assets/default-picture.jpg') }}";
  document.getElementById('image_url1').value = student.pic;

  $('#editStudentModal').modal('show');
  }
  // Validate image file type and size
  function validateFileType(file) {
    const allowedTypes = ["jpg", "jpeg", "png", "gif"];
    const extension = file.name.split('.').pop().toLowerCase();
    if (!allowedTypes.includes(extension)) {
      alert("Only jpg, jpeg, png, and gif files are allowed!");
      return false;
    }
    if (file.size > 1048576) { // 1MB
      alert("File size exceeds 1MB. Please choose a smaller file.");
      return false;
    }
    return true;
  }

  // ID format validation on submit
  $("#addStudentForm").submit(function (event) {
    const inputValue = $("#idnumber").val();
    const regex = /^\d{4}-\d{4}$/;
    if (!regex.test(inputValue)) {
      event.preventDefault();
      alert("Invalid ID format. Please use the format: YYYY-NNNN (e.g., 2023-1234)");
    }
  });

  // Close Add Modal button
  $("#closeAddModalButton").click(function () {
    $("#addStudentModal").modal("hide");
  });

  // Delete confirmation
  $("#deleteStudentFromList").click(function (event) {
    if (!confirm("Are you sure you want to delete this student?")) {
      event.preventDefault();
    }
  });

  // Search functionality
  function performSearch() {
    var searchField = $("#searchField").val();
    var searchQuery = $("#searchInput").val().toLowerCase().trim();

    $(".table-hover tbody tr").each(function () {
      var rowData = (searchField === "all") ? $(this).text().toLowerCase() : $(this).find("." + searchField).text().toLowerCase();

      if (rowData.includes(searchQuery)) {
        $(this).show();
      } else {
        $(this).hide();
      }
    });
  }

  $("#searchButton").click(function(event) {
    event.preventDefault();
    performSearch();
  });

  $("#searchForm").submit(function(event) {
    event.preventDefault();
    performSearch();
  });

  // Edit Modal Open & Populate
  $(".edit-button").click(function () {
    var studentPic = $(this).data("student-pic");
    var studentId = $(this).data("student-id");
    var firstname = $(this).data("firstname");
    var lastname = $(this).data("lastname");
    var course = $(this).data("course");
    var year = $(this).data("year");
    var gender = $(this).data("gender");
    
    // Save current image for fallback in previewImage1()
    currentImage = (studentPic && studentPic !== "None") ? studentPic : "{{ url_for('static', filename='assets/default-picture.jpg') }}";

    // Populate form fields
    $("#editStudentForm input[name='studentID']").val(studentId);
    $("#editStudentForm input[name='firstname']").val(firstname);
    $("#editStudentForm input[name='lastname']").val(lastname);
    $("#editStudentForm select[name='course']").val(course);
    $("#editStudentForm input[name='year']").val(year);
    $("#editStudentForm select[name='gender']").val(gender);
    $("#currentCourse").val(course);
    
    // Set preview image src
    $("#preview-image1").attr("src", currentImage);
    $("#editStudentForm input[name='image_url1']").val(studentPic || "");
    
    $("#editStudentModal").modal("show");
  });

  // Close Edit Modal button
  $("#closeEditModalButton").click(function () {
    $("#editStudentModal").modal("hide");
  });

 

  // Student Details modal on row click except buttons
  $(".table tbody tr").click(function (event) {
    if ($(event.target).hasClass("row-button")) {
      return; // Ignore if clicked on buttons inside row
    }
    var studentPic = $(this).find(".img").attr('src');
    var studentID = $(this).find(".id").text();
    var firstname = $(this).find(".firstname").text();
    var lastname = $(this).find(".lastname").text();
    var course = $(this).find(".course").text();
    var college = $(this).find(".college").text();
    var year = $(this).find(".year").text();
    var gender = $(this).find(".gender").text();

    // Fix typo in IDs for detail modal
    $("#detailsStudentPic").attr('src', studentPic);
    $("#detailsStudentID").text(studentID);
    $("#detailsFirstname").text(firstname);  // fixed from detailsFirstnName
    $("#detailsLastname").text(lastname);
    $("#detailsCourse").text(course);
    $("#detailsCollege").text(college);
    $("#detailsYear").text(year);
    $("#detailsGender").text(gender);

    $("#studentDetailsModal").modal("show");
  });

});

// Image validation helper
function validateFileType(file) {
  var idxDot = file.name.lastIndexOf(".") + 1;
  var extFile = file.name.substr(idxDot).toLowerCase();

  if (["jpg", "jpeg", "png", "gif"].includes(extFile)) {
    if (file.size <= 1048576) {
      return true;
    } else {
      alert("File size exceeds 1MB. Please choose a smaller file.");
      return false;
    }
  } else {
    alert("Only jpg, jpeg, png, and gif files are allowed!");
    return false;
  }
}

// Preview image for Add form
function previewImage(event) {
  const file = event.target.files[0];
  const preview = document.getElementById('preview-image');

  if (validateFileType(file)) {
    const reader = new FileReader();
    reader.onload = function (e) {
      preview.src = e.target.result;
      preview.style.display = 'block';
      preview.style.opacity = '1';
    };
    reader.readAsDataURL(file);
  }
}
document.addEventListener("DOMContentLoaded", function () {
  const editButtons = document.querySelectorAll(".edit-button");

  editButtons.forEach((button) => {
    button.addEventListener("click", function () {
      const studentID = this.getAttribute("data-student-id");
      const firstname = this.getAttribute("data-firstname");
      const lastname = this.getAttribute("data-lastname");
      const course = this.getAttribute("data-course");
      const year = this.getAttribute("data-year");
      const gender = this.getAttribute("data-gender");
      const pic = this.getAttribute("data-student-pic") || "/static/assets/default-picture.jpg";

      // Populate the edit form fields
      document.getElementById("idnumber").value = studentID;   // <-- fixed id here
      document.querySelector("input[name='originalStudentID']").value = studentID;
      document.getElementById("firstname").value = firstname;
      document.getElementById("lastname").value = lastname;
      document.getElementById("course").value = course;
      document.getElementById("year").value = year;
      document.getElementById("gender").value = gender;

      // Update image preview
      const previewImage = document.getElementById("preview-image1");
      previewImage.src = pic;

      // Show the modal
      $('#editStudentModal').modal('show');
    });
  });
});

// Preview image for Edit form
function previewImage1(event) {
  const file = event.target.files[0];
  const preview = document.getElementById('preview-image1');

  const reader = new FileReader();
  reader.onload = function (e) {
    if (file) {
      if (validateFileType(file)) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        preview.style.opacity = '1';
        preview.dataset.studentPic = file.name;
      } else {
        // fallback to currentImage or default
        preview.src = currentImage || "{{ url_for('static', filename='assets/default-picture.jpg') }}";
        preview.style.opacity = '0.8';
      }
    } else {
      preview.src = currentImage || "{{ url_for('static', filename='assets/default-picture.jpg') }}";
      preview.style.opacity = '0.8';
    }
  };
  

  if (file) reader.readAsDataURL(file);
}


</script>


  {% endblock %}
    
